var WorkflowManagerEngine=WorkflowManagerEngine||{};function WorkflowManagerEngine(e){e=void 0===e?{}:e,this.routingGroups=[],this.CurrentUserProperties=e,this.SecurityStatus={none:"Your are not authorized to access this resource..",before:"You can not currently take action on this request because its not at your stage..",after:"You have already taken an action on this request.."},this.updateStageByName=function(e){var s=0,t=this.routingGroups;if(void 0!==e.name&&void 0!==e.condition&&void 0!==e.authenticationType&&void 0!==e.authenticationValue&&void 0!==e.emails){for(var a=0;a<=t.length-1;a++)for(var o=0;o<=t[a].possibleRoutes.length-1;o++)t[a].possibleRoutes[o].name==e.name&&(t[a].possibleRoutes[o]=e,s++);return 0==s?"No stage Found":"update successful"}if(void 0===e.name||void 0===e.authenticationValue&&void 0===e.emails&&void 0===e.condition&&void 0===e.users)return"invalid object";for(a=0;a<=t.length-1;a++)for(o=0;o<=t[a].possibleRoutes.length-1;o++)t[a].possibleRoutes[o].name==e.name&&(void 0!==e.username&&(t[a].possibleRoutes[o].username=e.username),void 0!==e.authenticationValue&&(t[a].possibleRoutes[o].authenticationValue=e.authenticationValue),void 0!==e.emails&&(t[a].possibleRoutes[o].emails=e.emails),void 0!==e.doa&&(t[a].possibleRoutes[o].doa=e.doa),void 0!==e.condition&&(t[a].possibleRoutes[o].condition=e.condition),void 0!==e.users&&(t[a].possibleRoutes[o].users=e.users),void 0!==e.flow&&(t[a].possibleRoutes[o].flow=e.flow),s++);return 0==s?"No stage Found":"update successful"},this.updateStageName=function(e,s){for(var t=0,a=this.routingGroups,o=0;o<=a.length-1;o++)for(var r=0;r<=a[o].possibleRoutes.length-1;r++)a[o].possibleRoutes[r].name==e&&(a[o].possibleRoutes[r].name=s,t++);return 0==t?"No stage Found":"update successful"},this.updateUsersInNotNormalFlow=function(e){var s=[],t=0,a=this.routingGroups;if(void 0!==e.stage){for(var o=0;o<=a.length-1;o++)for(var r=0;r<=a[o].possibleRoutes.length-1;r++)if(a[o].possibleRoutes[r].name==e.stage&&a[o].possibleRoutes[r].flow!==this.stages.normal)for(var i=a[o].possibleRoutes[r].users,n=0;n<=i.length-1;n++)if(i[n].login.toLowerCase()==e.login.toLowerCase()&&i[n].status.toLowerCase()!==this.stages.approve.toLowerCase()&&i[n].status.toLowerCase()!==this.stages.reject.toLowerCase()){void 0!==e.status&&(a[o].possibleRoutes[r].users[n].status=e.status,a[o].possibleRoutes[r].users[n].workliststatus=e.login+"|"+e.status),void 0!==e.name&&(a[o].possibleRoutes[r].users[n].name=e.name),void 0!==e.email&&(a[o].possibleRoutes[r].users[n].email=e.email),void 0!==e.ismember&&(a[o].possibleRoutes[r].users[n].ismember=e.ismember),s=a[o].possibleRoutes[r].users,t++;break}return 0==t?[]:s}return[]},this.getStagebyName=function(e,s){var t=void 0===s?"":s,a={},o=this.routingGroups;if(void 0!==e)for(var r=0;r<=o.length-1;r++)for(var i=0;i<=o[r].possibleRoutes.length-1;i++)if(o[r].possibleRoutes[i].name==e)if(o[r].possibleRoutes[i].flow===this.stages.normal)a=o[r].possibleRoutes[i];else if(o[r].possibleRoutes[i].flow===this.stages.sequencial){a=o[r].possibleRoutes[i];for(var n=0;n<=a.users.length-1;n++)if(a.users[n].status.toLowerCase()===this.stages.pending.toLowerCase()||a.users[n].status.toLowerCase()===this.stages.more.toLowerCase()){a.emails=[],a.emails.push(a.users[n].email[0]),a.authenticationValue=a.users[n].login,a.username=a.users[n].name;break}}else if(o[r].possibleRoutes[i].flow===this.stages.parallel)for((a=o[r].possibleRoutes[i]).emails=[],n=0;n<=a.users.length-1;n++)a.authenticationType===this.stages.user?(a.emails.push(a.users[n].email[0]),a.authenticationValue||(a.authenticationValue=a.users[n].login.toLowerCase()===t.toLowerCase())):(a.emails=a.emails.concat(a.users[n].email),a.authenticationValue||(a.authenticationValue=a.users[n].ismember));return a},this.getAllStagesWithName=function(e){var s=[],t=this.routingGroups;if(void 0!==e)for(var a=0;a<=t.length-1;a++)for(var o=0;o<=t[a].possibleRoutes.length-1;o++)if(t[a].possibleRoutes[o].name==e){var r={};r.code=t[a].code,r.initiationCode=t[a].initiationCode,r.codeBeforeUpdate=r.code,void 0!==t[a].codeBeforeUpdate&&(r.codeBeforeUpdate=t[a].codeBeforeUpdate),s.push(r)}return s},this.getAllGroupsInWorkflow=function(){for(var e=[],s=this.routingGroups,t=0;t<=s.length-1;t++)for(var a=0;a<=s[t].possibleRoutes.length-1;a++)if(s[t].possibleRoutes[a].authenticationType==this.stages.group){for(var o=!1,r=0;r<e.length;r++)if(e[r].toLowerCase()===s[t].possibleRoutes[a].name.toLowerCase()){o=!0;break}o||e.push(s[t].possibleRoutes[a].name)}return e},this.getAllUsersInWorkflow=function(){for(var e=[],s=this.routingGroups,t=0;t<=s.length-1;t++)for(var a=0;a<=s[t].possibleRoutes.length-1;a++)if(s[t].possibleRoutes[a].authenticationType==this.stages.user){for(var o=!1,r=0;r<e.length;r++)if(e[r].toLowerCase()===s[t].possibleRoutes[a].name.toLowerCase()){o=!0;break}o||e.push(s[t].possibleRoutes[a].name)}return e},this.stages={completed:"Completed",pending:"Pending",approve:"Approved",reject:"Declined",more:"MoreInfo",save:"Save For Later",modified:"Returned For Approval",current:"",previous:"",currentStageCode:"",pendingUserLogin:"",pendingUserEmail:"",currentUserName:"",previousUserName:"",emailAction:"",userGroupForNonNormalState:"",normal:"normal",sequencial:"sequencial",parallel:"parallel",group:"Group",user:"User",securityModeTask:"Task",securityModeView:"View",initiatorCode:"AA0"},this.routeEngine=function(e){var s=e.routingGroups;return{nextActor:function(t){for(var a=null,o=0;o<=s.length-1;o++)if(s[o].initiationCode==t){for(var r=s[o].possibleRoutes,i=0;i<=r.length-1;i++)if(r[i].condition){if(r[i].flow===e.stages.normal){a=r[i],e.stages.current=r[i].name,e.stages.currentStageCode=s[o].code,e.stages.currentUserName=r[i].username,r[i].authenticationType==e.stages.group?(e.stages.pendingUserLogin=r[i].name,e.stages.pendingUserEmail=r[i].name):(e.stages.pendingUserLogin=r[i].authenticationValue,e.stages.pendingUserEmail=r[i].emails[0]);break}if(r[i].flow===e.stages.sequencial){for(var n=0;n<=r[i].users.length-1;n++)if(r[i].users[n].status.toLowerCase()===e.stages.pending.toLowerCase()||r[i].users[n].status.toLowerCase()===e.stages.more.toLowerCase()){a=r[i],e.stages.current=r[i].name,e.stages.currentStageCode=s[o].code,e.stages.currentUserName=r[i].users[n].name,r[i].authenticationType==e.stages.group?(e.stages.pendingUserLogin=r[i].users[n].name,e.stages.pendingUserEmail=r[i].users[n].name):(e.stages.pendingUserLogin=r[i].users[n].login,e.stages.pendingUserEmail=r[i].users[n].email[0]);break}}else if(r[i].flow===e.stages.parallel)for(n=0;n<=r[i].users.length-1;n++)if(r[i].users[n].status.toLowerCase()===e.stages.pending.toLowerCase()||r[i].users[n].status.toLowerCase()===e.stages.more.toLowerCase()){a=r[i],e.stages.current=r[i].name,e.stages.currentStageCode=s[o].code,e.stages.currentUserName=r[i].name,e.stages.pendingUserLogin=r[i].name,e.stages.pendingUserEmail=r[i].name;break}}if(null!=a)break}return null===a&&(a={name:e.stages.completed,condition:null,username:"",authenticationType:null,authenticationValue:null,actionType:""},e.stages.current=e.stages.completed,e.stages.currentStageCode=e.stages.completed,e.stages.pendingUserLogin=e.stages.completed,e.stages.currentUserName=e.stages.completed,e.stages.pendingUserEmail=e.stages.completed,e.stages.currentUserName=e.stages.completed),a},nextActorNotNormal:function(t,a,o,r,i){var n="";r===e.stages.user?n=e.CurrentUserProperties.login:r===e.stages.group&&(n=e.stages.userGroupForNonNormalState),(i=void 0!==i&&i)||e.updateUsersInNotNormalFlow({status:o,login:n,stage:a});for(var u=null,l=0;l<=s.length-1;l++)if(s[l].code==t)for(var g=s[l].possibleRoutes,d=0;d<=g.length-1;d++)if(g[d].condition)if(g[d].flow===e.stages.sequencial){for(var p=0;p<=g[d].users.length-1;p++)if(g[d].users[p].status.toLowerCase()===e.stages.pending.toLowerCase()||g[d].users[p].status.toLowerCase()===e.stages.more.toLowerCase()){u={},u=g[d],e.stages.current=g[d].name,e.stages.currentStageCode=t,e.stages.currentUserName=g[d].users[p].name,g[d].authenticationType==e.stages.group?(e.stages.pendingUserLogin=g[d].users[p].name,e.stages.pendingUserEmail=g[d].users[p].name):(e.stages.pendingUserLogin=g[d].users[p].login,e.stages.pendingUserEmail=g[d].users[p].email[0]);break}if(null!=u)break}else if(g[d].flow===e.stages.parallel){for(p=0;p<=g[d].users.length-1;p++)if(g[d].users[p].status.toLowerCase()===e.stages.pending.toLowerCase()||g[d].users[p].status.toLowerCase()===e.stages.more.toLowerCase()){u={},u=g[d],e.stages.current=g[d].name,e.stages.currentStageCode=t,e.stages.currentUserName=g[d].name,e.stages.pendingUserLogin=g[d].name,e.stages.pendingUserEmail=g[d].name;break}if(null!=u)break}null===u&&this.nextActor(t)},currentActor:function(t){for(var a=null,o=0;o<=s.length-1;o++)if(s[o].code==t){for(var r=s[o].possibleRoutes,i=0;i<=r.length-1;i++)if(r[i].condition){if(r[i].flow===e.stages.normal)a=r[i];else if(r[i].flow===e.stages.sequencial){a={};for(var n=0;n<=r[i].users.length-1;n++)if(r[i].users[n].status.toLowerCase()===e.stages.pending.toLowerCase()||r[i].users[n].status.toLowerCase()===e.stages.more.toLowerCase()){a.name=r[i].name,a.username=r[i].users[n].name,a.authenticationValue=r[i].users[n].login,a.emails=r[i].users[n].email,a.authenticationType=r[i].authenticationType,a.users=r[i].users,a.flow=r[i].flow,a.doa=r[i].doa,a.code=s[o].code,a.initiationCode=s[o].initiationCode;break}}else if(r[i].flow===e.stages.parallel)for(a={emails:[]},n=0;n<=r[i].users.length-1;n++)r[i].users[n].status.toLowerCase()!==e.stages.pending.toLowerCase()&&r[i].users[n].status.toLowerCase()!==e.stages.more.toLowerCase()||(a.name=r[i].name,a.username=r[i].name,a.authenticationValue=r[i].name,a.emails.push(r[i].users[n].email[0]),a.authenticationType=e.stages.group,a.users=r[i].users,a.flow=r[i].flow,a.doa=r[i].doa,a.code=s[o].code,a.initiationCode=s[o].initiationCode);break}if(null!=a)break}return null===a&&(a={}),a},previousActor:function(e){for(var t=null,a=0;a<=s.length-1;a++)if(s[a].code==e){t=a-1;break}if(null===t)t={};else var o=s[t];return o},runRouting:function(s,t,a,o){var r=this.currentActor(t),i=this.currentActor(e.stages.initiatorCode);return t!==e.stages.initiatorCode&&(t=this.getCurrentRouteCodeifRouteUpdate(r.name,t,r)),a=void 0===a?e.stages.approve:a,r.flow===e.stages.normal||t===e.stages.initiatorCode?this.nextActor(t):this.nextActorNotNormal(t,r.name,a,r.authenticationType,o),e.stages.previousUserName=void 0!==r.username?r.username:"",a==e.stages.modified?(r.authenticationType==e.stages.user?(s.PendingUserLogin=r.authenticationValue,s.PendingUserEmail=r.emails[0]):(s.PendingUserLogin=r.name,s.PendingUserEmail=r.name),s.ReturnForCorrection="No",e.stages.currentUserName=r.username,e.stages.emailAction=r.name):a==e.stages.approve?(s.Current_Approver=e.stages.current,s.Current_Approver_Code=e.stages.currentStageCode,s.PendingUserLogin=e.stages.pendingUserLogin,s.PendingUserEmail=e.stages.pendingUserEmail,s.Approval_Status=e.stages.pending,e.stages.emailAction=s.Current_Approver,e.stages.current===e.stages.completed&&(s.Approval_Status=e.stages.completed,e.stages.emailAction=e.stages.completed),s.ReturnForCorrection="No"):a==e.stages.reject?(s.Approval_Status=e.stages.reject,e.stages.emailAction=e.stages.reject,s.ReturnForCorrection="No"):a==e.stages.more?(s.PendingUserLogin=i.authenticationValue,s.PendingUserEmail=i.emails[0],s.ReturnForCorrection="Yes",e.stages.emailAction=e.stages.more):a==e.stages.save&&(s.Current_Approver=e.stages.save,s.Current_Approver_Code=e.stages.initiatorCode,s.PendingUserLogin=i.authenticationValue,s.PendingUserEmail=i.emails[0],s.Approval_Status=e.stages.pending),s},getCurrentRouteCodeifRouteUpdate:function(s,t,a){var o=t;if((a=void 0!==a?a:this.currentActor(t)).name!==s)for(var r=e.getAllStagesWithName(s),i=0;i<r.length;i++)if(Array.isArray(r[i].codeBeforeUpdate)){for(var n=!1,u=0;u<r[i].codeBeforeUpdate.length;u++)if(r[i].codeBeforeUpdate[u]===t){o=r[i].code,n=!0;break}if(n)break}else if(r[i].codeBeforeUpdate===t){o=r[i].code;break}return o},requestHistoryHandler:function(s,t,a){var o={};o.name=void 0===a.name?e.CurrentUserProperties.title:a.name,o.email=void 0===a.email?e.CurrentUserProperties.email:a.email;try{o.actiontime=void 0===a.actiontime?$spcontext.stringnifyDate({includeTime:!0}):a.actiontime}catch(r){o.actiontime=void 0===a.actiontime?"":a.actiontime}return o.stage=void 0===a.stage?"Initiator":a.stage,o.action=void 0===a.action?"Sent For Approval":a.action,o.comment=void 0===a.comment?"":a.comment,o.signature=void 0===a.signature?"":a.signature,o.login=void 0===a.login?e.CurrentUserProperties.login:a.login,t.push(o),s.Transaction_History=JSON.stringify(t),s},updateWorkflowGroups:function(s,t,a,o,r){o=void 0===o||o;for(var i="",n=0;n<t.length;n++)i+=n==t.length-1?t[n]:t[n]+";";var u={returnCollection:!0,groupEmails:!0};if(u[s]=e.CurrentUserProperties[s],o)$spcontext.isUserMemberOfGroup(i,u,(function(e,s){for(var o=0;o<t.length;o++)customWorkflowEngine.updateStageByName({name:t[o],username:t[o],emails:s[t[o]].emails,authenticationValue:s[t[o]].belongs});void 0!==a&&"function"==typeof a&&a(s)}));else{for(var l=0;l<t.length;l++)customWorkflowEngine.updateStageByName({name:t[l],username:t[l],emails:r[t[l]].emails,authenticationValue:r[t[l]].belongs});void 0!==a&&"function"==typeof a&&a(r)}},updateRoutesinFlow:function(s,t,a,o){for(var r=e.getAllGroupsInWorkflow(),i=e.CurrentUserProperties.login===e.CurrentUserProperties.email?"email":"login",n=e.getAllUsersInWorkflow(),u=0;u<n.length;u++){var l=s[n[u]];void 0!==l&&(Array.isArray(l)?e.updateStageByName({name:n[u],username:l[0].value,authenticationValue:l[0][i],emails:[l[0].email]}):e.updateStageByName({name:n[u],username:l.value,authenticationValue:l[i],emails:[l.email]}))}this.updateWorkflowGroups(i,r,t,a,o)},PageSecurity:function(s,t,a,o){if(s===e.stages.securityModeTask)if(this.security(t,a))o();else{var r=this.failedSecurityError(t);o(e.SecurityStatus[r])}else this.security(t,a)?o():o(e.SecurityStatus.none)},security:function(s,t){var a=!1;if(t===e.stages.pending){var o=e.getStagebyName(s,e.CurrentUserProperties.login);if(o.flow===e.stages.normal)(o.authenticationType==e.stages.group&&o.authenticationValue||o.authenticationType==e.stages.user&&e.CurrentUserProperties.login==o.authenticationValue)&&(a=!0);else if(o.flow===e.stages.sequencial){if(o.authenticationType==e.stages.group&&o.authenticationValue)a=!0;else for(var r=0;r<o.users.length;r++)if(o.authenticationType==e.stages.user&&e.CurrentUserProperties.login==o.authenticationValue&&(o.users[r].status.toLowerCase()===e.stages.pending.toLowerCase()||o.users[r].status.toLowerCase()===e.stages.more.toLowerCase())){a=!0;break}}else if(o.flow===e.stages.parallel)for(r=0;r<o.users.length;r++)if(o.authenticationType==e.stages.group){if(o.users[r].ismember&&(o.users[r].status.toLowerCase()===e.stages.pending.toLowerCase()||o.users[r].status.toLowerCase()===e.stages.more.toLowerCase())){a=!0;break}}else if(o.users[r].login.toLowerCase()==e.CurrentUserProperties.login&&(o.users[r].status.toLowerCase()===e.stages.pending.toLowerCase()||o.users[r].status.toLowerCase()===e.stages.more.toLowerCase())){a=!0;break}}return a},failedSecurityError:function(t){for(var a="none",o=0;o<=s.length-1;o++)for(var r=s[o].possibleRoutes,i=0;i<=r.length-1;i++)if(r[i].condition)if(r[i].flow===e.stages.normal)(r[i].authenticationValue===e.CurrentUserProperties.login&&r[i].authenticationType===e.stages.user||r[i].authenticationValue&&r[i].authenticationType===e.stages.group)&&(a=s[o].code>t?"after":"before");else if(r[i].flow===e.stages.sequencial)for(var n=0;n<=r[i].users.length-1;n++)r[i].users[n].login===e.CurrentUserProperties.login&&(a=r[i].users[n].status.toLowerCase()===e.stages.pending.toLowerCase()?"after":"before");else if(r[i].flow===e.stages.parallel)for(n=0;n<=r[i].users.length-1;n++)r[i].users[n].login===e.CurrentUserProperties.login&&(a=r[i].users[n].status.toLowerCase()===e.stages.pending.toLowerCase()?"after":"before");return a},viewSecurity:function(t){var a=!1,o=this.currentActor(e.stages.initiatorCode);if(e.CurrentUserProperties.login==o.authenticationValue)return!0;if(void 0!==t&&Array.isArray(t)){for(var r=!1,i=0;i<t.length;i++)if(t[i]===e.CurrentUserProperties.login){r=!0;break}if(r)return r}for(var n=0;n<=s.length-1;n++)for(var u=s[n].possibleRoutes,l=0;l<=u.length-1;l++)if(u[l].flow===e.stages.normal){if(u[l].authenticationType==e.stages.group&&u[l].authenticationType){a=!0;break}if(u[l].authenticationType==e.stages.user&&e.CurrentUserProperties.login==u[l].authenticationValue){a=!0;break}}else if(u[l].flow===e.stages.sequencial){for(var g=0;g<u[l].users.length;g++)if(u[l].authenticationType==e.stages.user&&e.CurrentUserProperties.login==u[l].authenticationValue&&(u[l].users[g].status.toLowerCase()===e.stages.pending.toLowerCase()||u[l].users[g].status.toLowerCase()===e.stages.more.toLowerCase())){a=!0;break}if(a)break}else if(u[l].flow===e.stages.parallel){for(g=0;g<u[l].users.length;g++)if(u[l].authenticationValue&&(u[l].users[g].status.toLowerCase()===e.stages.pending.toLowerCase()||u[l].users[g].status.toLowerCase()===e.stages.more.toLowerCase())){a=!0;break}if(a)break}return a},templateReplacement:function(s,t,a){var o=a[s];for(var r in t)try{var i=new RegExp("{{"+r+"}}","g");o=o.replace(i,t[r])}catch(n){}o=(o=(o=o.replace(/{{currentapprover}}/g,e.stages.currentUserName)).replace(/{{previousapprover}}/g,e.stages.previousUserName)).replace(/{{newline}}/g,"<br><br>");try{o=o.replace(/{{Author}}/g,t.Author.value)}catch(n){}return o},extendRouteEngine:{}}},this.AppInstallation=function(e,s,t){var a=[{columnField:'<Field DisplayName="Current_Approver" Type="Text" />',fieldOptions:SP.AddFieldOptions.defaultValue,fieldType:SP.FieldText,addToDefault:!0},{columnField:'<Field DisplayName="Current_Approver_Code" Type="Text" />',fieldOptions:SP.AddFieldOptions.defaultValue,fieldType:SP.FieldText,addToDefault:!0},{columnField:'<Field DisplayName="Approval_Status" Type="Text" />',fieldOptions:SP.AddFieldOptions.defaultValue,fieldType:SP.FieldText,addToDefault:!0},{columnField:'<Field DisplayName="PendingUserLogin" Type="Text" />',fieldOptions:SP.AddFieldOptions.defaultValue,fieldType:SP.FieldText,addToDefault:!0},{columnField:'<Field DisplayName="PendingUserEmail" Type="Text" />',fieldOptions:SP.AddFieldOptions.defaultValue,fieldType:SP.FieldText,addToDefault:!0},{columnField:'<Field DisplayName="ReturnForCorrection" Type="Text" />',fieldOptions:SP.AddFieldOptions.defaultValue,fieldType:SP.FieldText,addToDefault:!0},{columnField:'<Field DisplayName="Transaction_History" Type="Note" RichText="FALSE" />',fieldOptions:SP.AddFieldOptions.defaultValue,fieldType:SP.FieldMultiLineText,addToDefault:!0},{columnField:'<Field DisplayName="InitiatorLogin" Type="Text" />',fieldOptions:SP.AddFieldOptions.defaultValue,fieldType:SP.FieldText,addToDefault:!0},{columnField:'<Field DisplayName="InitiatorEmailAddress" Type="Text" />',fieldOptions:SP.AddFieldOptions.defaultValue,fieldType:SP.FieldText,addToDefault:!0},{columnField:'<Field DisplayName="WorkflowRequestID" Type="Text" />',fieldOptions:SP.AddFieldOptions.defaultValue,fieldType:SP.FieldText,addToDefault:!0},{columnField:'<Field DisplayName="Attachment_Folder" Type="Text" />',fieldOptions:SP.AddFieldOptions.defaultValue,fieldType:SP.FieldText,addToDefault:!0},{columnField:'<Field DisplayName="AttachmentURL" Type="Note" RichText="FALSE" />',fieldOptions:SP.AddFieldOptions.defaultValue,fieldType:SP.FieldMultiLineText,addToDefault:!0}];e.formAppInitialization(s,a,t)}}